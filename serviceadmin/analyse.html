<!DOCTYPE html>
<html lang="zh-cn">
<head>
<link rel="stylesheet" type="text/css" href="../css/newcss.css"/>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="Creative - Bootstrap 3 Responsive Admin Template" />
<meta name="author" content="GeeksLabs" />
<meta name="keyword" content="Creative, Dashboard, Admin, Template, Theme, Bootstrap, Responsive, Retina, Minimal" />

<script src="../js/jquery-1.11.1.min.js"></script>
<script src="../js/jquery.cookie.js"></script>
<script src="../js/naibowang/getUrlParam.js"></script>
<link href="js/jquery.vector-map.css" media="screen" rel="stylesheet" type="text/css" />
<script src="js/jquery.vector-map.js" type="text/javascript"></script>
<script src="js/china-zh.js" type="text/javascript"></script>
<title>API统计分析</title>
<!-- Bootstrap CSS -->
<link href="css/bootstrap.min.css" rel="stylesheet" />
<!-- bootstrap theme -->
<link href="css/bootstrap-theme.css" rel="stylesheet" />
<!--external css-->
<!-- font icon -->
<link href="css/elegant-icons-style.css" rel="stylesheet" />
<link href="css/font-awesome.min.css" rel="stylesheet" />
<!-- full calendar css-->
<link href="assets/fullcalendar/fullcalendar/bootstrap-fullcalendar.css" rel="stylesheet" />
<link href="assets/fullcalendar/fullcalendar/fullcalendar.css" rel="stylesheet" />
<!-- easy pie chart-->
<link href="assets/jquery-easy-pie-chart/jquery.easy-pie-chart.css" rel="stylesheet" type="text/css" media="screen" />
<!-- owl carousel -->
<link rel="stylesheet" href="css/owl.carousel.css" type="text/css" />
<link href="css/jquery-jvectormap-1.2.2.css" rel="stylesheet" />
<!-- Custom styles -->
<link rel="stylesheet" href="css/fullcalendar.css" />
<link href="css/widgets.css" rel="stylesheet" />
<link href="css/style.css" rel="stylesheet" />
<link href="css/style-responsive.css" rel="stylesheet" />
<link href="css/xcharts.min.css" rel=" stylesheet" />
<link href="css/jquery-ui-1.10.4.min.css" rel="stylesheet" />
<!-- HTML5 shim and Respond.js IE8 support of HTML5 -->
<!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
      <script src="js/respond.min.js"></script>
      <script src="js/lte-ie7.js"></script>
    <![endif]-->
</head>
<body>
<!-- container section start -->
<section id="container" class="">
  <header class="header dark-bg">
    <div class="toggle-nav">
      <div class="icon-reorder tooltips" data-original-title="Toggle Navigation" data-placement="bottom"></div>
    </div>
    <!--logo start--> 
    <img class='gflogo' src="../images/api-logo_95fb06f.png"/>
    <!--logo end-->
    <div class="top-nav notification-row"> 
      <!-- notificatoin dropdown start-->
      <ul class="nav pull-right top-menu">
        <li id="usname" style="line-height: 30px"></li>
        <li>
          <button class="btn btn-default" id="logout">注销</button>
        </li>
        <!-- user login dropdown end -->
      </ul>
      <!-- notificatoin dropdown end--> 
    </div>
  </header>
  <aside>
    <div id="sidebar" class="nav-collapse "> 
      <!-- sidebar menu start-->
      <ul class="sidebar-menu">
        <li class="active"> <a class="" href="index.html"> <i class="icon_house_alt"></i> <span>服务台</span> </a> </li>
      </ul>
      <!-- sidebar menu end--> 
    </div>
  </aside>
  <section id="main-content">
    <section class="wrapper">
      <div class="row">
        <div class="col-lg-12">
          <h3 class="page-header"><i class="fa fa-laptop"></i>服务台</h3>
          <ol class="breadcrumb">
            <li><i class="fa fa-home"></i><a href="index.html">主页</a></li>
            <li><i class="fa fa-laptop"></i><a href="index.html">服务台</a></li>
            <li><i class="fa fa-book"></i><a href="apimanage.html" id="apimanage">API管理</a></li>
            <li><i class="fa fa-edit"></i>API统计分析</li>
          </ol>
        </div>
      </div>
      <div class="table-responsive">
        <p></p>
        <p></p>
        <p></p>
        <p></p>
        <div class="col-lg-12" style="padding: 0">
          <section class="panel">
            <header class="panel-heading"> API趋势研究 </header>
            <div class="panel-body text-center table-responsive">
              <h4 align="center" id="servicename" style="margin-bottom: 20px">API统计分析</h4>
              <form class="form-inline" role="form" onSubmit="return gettime()" id="theform">
                <div class="form-group">
                  <label for="exampleInputPassword2">开始日期：</label>
                </div>
                <div class="form-group">
                  <input type="date" class="form-control" required id="starttime" >
                </div>
                <div class="form-group">
                  <label for="exampleInputPassword2">&nbsp;截止日期：</label>
                </div>
                <div class="form-group">
                  <input type="date" class="form-control" required id="endtime">
                </div>
                <button type="submit" class="btn btn-primary">查询</button>
                <div class="form-group">
                  <button type="button" class="btn btn-default" id="seven">近7天</button>
                </div>
                <div class="form-group">
                  <button type="button" class="btn btn-default" id="thirty">近30天</button>
                </div>
                 <div class="form-group">
                  <label for="exampleInputPassword2" id="status">&nbsp;状态：正在查询</label>
                </div>
              </form>
              <h4 align="center" id="servicename" style="margin-bottom: 10px">API调用次数（日期/次数）</h4>
              <canvas id="line" height="300"></canvas>
            </div>
          </section>
          <section class="panel">
            <header class="panel-heading"> 服务消费者画像 </header>
            <div class="panel-body text-center table-responsive">
              <form class="form-inline" role="form" style="margin-bottom: 10px;" onSubmit="return getdata()" id="theform2">
                <div class="form-group">
                  <label for="exampleInputPassword2">开始日期：</label>
                </div>
                <div class="form-group">
                  <input type="date" class="form-control" required id="starttime2" >
                </div>
                <div class="form-group">
                  <label for="exampleInputPassword2">&nbsp;截止日期：</label>
                </div>
                <div class="form-group">
                  <input type="date" class="form-control" required id="endtime2">
                </div>
                <button type="submit" class="btn btn-primary">查询</button>
                <div class="form-group">
                  <button type="button" class="btn btn-default" id="seven2">近7天</button>
                </div>
                <div class="form-group">
                  <button type="button" class="btn btn-default" id="thirty2">近30天</button>
                </div>
                <div class="form-group">
                  <label for="exampleInputPassword2" id="status2">&nbsp;状态：正在查询</label>
                </div>
              </form>
              <div id="containers" style="margin-left: 45px; padding-top: 10px; padding-left: 10px;
        background: white; width: 650px; height: 530px;" class="col-lg-6"> </div>
              <div class="col-lg-1"></div>
              <div class="col-lg-2">
                <table class="table">
                  <style>
					th,td
						{
							text-align: center;
						}
					  h4
					  {
						  font-family: '微软雅黑';
					  }
					</style>
                  <thead>
                  <h4 style="font-family: '微软雅黑'">省份调用次数排名</h4>
                  <tr>
                    <th>ID</th>
                    <th>省份</th>
                    <th>调用次数</th>
                  </tr>
                    </thead>
                  
                  <tbody id="rank">
                  </tbody>
                </table>
              </div>
            </div>
          </section>
          <script type="text/javascript">
			  checklogin();
			   function getdata()
			   {
				   if($("#starttime2").val() >$("#endtime2").val())
					{
						alert("查询时间有误");
						return false;
					}
				   $("#status2").html("状态：正在查询");
				   $.get(server+"/apiCall/apiCallDetail.do?apiId="+getUrlParam("id")+"&begin="+$("#starttime2").val()+"&end="+$("#endtime2").val(), function(result){
					   if(result.status)
					{
						alert(result.msg);
						window.location.href="index.html";
						return;
					}
					   				   $("#status2").html("状态：查询完毕");
					   $("#containers").html("");
								   var dataStatus = result.data;
					               $('#containers').vectorMap({ map: 'china_zh',
                color: "#B4B4B4", //地图颜色
                onLabelShow: function (event, label, code) {//动态显示内容
                    $.each(dataStatus, function (i, items) {
                        if (code == items.cha) {
                            label.html(items.name +"<br/>"+ items.callNum+"次");
                        }
                    });
                }
				
            });
//					   按照调用次数排序
					 var sortdata = dataStatus.sort(function(a,b)
					 {
					   return b.callNum - a.callNum;
				   })
//					 筛选出不为0的省份进行涂色,同时分箱操作让同一个值的省份的颜色相同
					 var showdata = sortdata.filter(function(item){return item.callNum>0});
					   var step = (showdata.length /4).toFixed(0);
					   var tnum = 0;
					   var colorr = "";
							$.each(showdata, function (i, items) {
								var josnStr="{" + items.cha + ":'rgba(";//默认灰色
								var jsonStr="218,228,231,1";//默认灰色
								if(tnum == items.callNum)
									{
										jsonStr = colorr;
									}
								else{
									if (i<step)
										jsonStr = "61,199,244,1";
									else if(i<2*step)
										jsonStr = "106,202,233,1";
									else if(i<3*step)
										jsonStr = "146,207,227,1";
									else if(i<4*step)
										jsonStr = "211,226,231,1";
									tnum = items.callNum;
									colorr = jsonStr;
								}
								josnStr = josnStr + jsonStr + ")'}";
								$('#containers').vectorMap('set', 'colors', eval('(' + josnStr + ')'));

				});$('.jvectormap-zoomin').click(); //放大s
					   $('.jvectormap-zoomout').html("-");
					 $("#rank").html("");
				   for(var i = 0;i<12;i++)
				   	$("#rank").append(`<tr><td>${i+1}</td><td>${sortdata[i].name}</td><td>${sortdata[i].callNum}</td></tr>`);   
				   });
					 return false;
			   }
      
    </script> 
        </div>
        <script>
		var sid = getUrlParam("sid");
		if(sid==null || sid =="")
			window.location.href="index.html";
			$("#apimanage").attr("href","apimanage.html?id="+getUrlParam("sid"));
			var tid = getUrlParam("id");
				  if(tid==null || tid =="")
					window.location.href="index.html";
				var link = server+"/api/detail.do?apiId="+getUrlParam("id");
				$.get(link,function(result){
					if(result.status)
					{
						alert(result.msg);
						window.location.href="index.html";
						return;
					}
					$("#servicename").html(result.data.name+"——API统计分析");
				});
				  function gettime()
				  {				  
					if($("#starttime").val() >=$("#endtime").val())
					{
						alert("查询时间有误,请至少查询两天");
						return false;
					} 
					  $("#status").html("状态：正在查询");
					  	$.get(server+"/apiCall/apiCallDailyInfo.do?apiId="+getUrlParam("id")+"&begin="+$("#starttime").val()+"&end="+$("#endtime").val(), function(result){
						if(result.status)
									{
										alert(result.msg);
										window.location.href="index.html";
										return;
									}
											   $("#status").html("状态：查询完毕");
						var y = result.data.groupData.daliyAnalysis;
//							根据数据集的大小对y轴进行步长计算
						var max = Math.max.apply(null, y);
							var ste = Math.ceil(max /15);
							if(ste<1)
							ste = 1;
						var x = result.data.xnames;
				  var lineChartData = {
						labels : x,

					datasets : [
						{
							fillColor : "rgba(220,220,220,0.5)",
							strokeColor : "blue",
							pointColor : "blue",
							pointStrokeColor : "#fff",
							data : y,
						}
					]
					};
//							根据数据集大小动态设置图标宽度
					var wid = 800;
					if(x.length>30)
						wid = 800 * x.length/30;
					$("#line").attr("width",wid);
					new Chart(document.getElementById("line").getContext("2d")).Line(lineChartData, {
								scaleOverride :true ,   //是否用硬编码重写y轴网格线
								scaleSteps : 15,        //y轴刻度的个数
								scaleStepWidth : ste,   //y轴每个刻度的宽度
								scaleStartValue : 0,    //y轴的起始值
								pointDot : true,        //是否显示点
								pointDotRadius : 5,     //点的半径
								pointDotStrokeWidth : 1,//点的线宽
								datasetStrokeWidth : 3, //数据线的线宽
								animation : true,       //是否有动画效果
								animationSteps : 60    //动画的步数
								} );
				  });
					  return false;
				  }
			function formatDate(str)//格式化字符串
			{
				var tim = str.split("-");
				var m = parseInt(tim[1]);
				var d = parseInt(tim[2]);
				if(m<10)
					m = "0" + m;
				if(d<10)
					d = "0" + d;
				return tim[0] + "-" + m + "-"+d;
			}
			var myDate = new Date();
			$("#seven").click(
				function(){
					var now = new Date();
					var date = new Date(now.getTime() - 7 * 24 * 3600 * 1000);
					var year = date.getFullYear();
					var month = date.getMonth() + 1;
					var day = date.getDate();
					$("#starttime").val(formatDate(year + '-' + month + '-' + day));
					$("#endtime").val(formatDate(myDate.toLocaleDateString().replaceAll("/","-")));
					$("#theform").submit();
				}
			);
			$("#seven2").click(
				function(){
					var now = new Date();
					var date = new Date(now.getTime() - 7 * 24 * 3600 * 1000);
					var year = date.getFullYear();
					var month = date.getMonth() + 1;
					var day = date.getDate();
					$("#starttime2").val(formatDate(year + '-' + month + '-' + day));
					$("#endtime2").val(formatDate(myDate.toLocaleDateString().replaceAll("/","-")));
					$("#theform2").submit();
				}
			);
			$("#thirty").click(
				function(){
					var now = new Date();
					var date = new Date(now.getTime() - 30 * 24 * 3600 * 1000);
					var year = date.getFullYear();
					var month = date.getMonth() + 1;
					var day = date.getDate();
					$("#starttime").val(formatDate(year + '-' + month + '-' + day));
					$("#endtime").val(formatDate(myDate.toLocaleDateString().replaceAll("/","-")));
					$("#theform").submit();
				}
			);
			$("#thirty2").click(
				function(){
					var now = new Date();
					var date = new Date(now.getTime() - 30 * 24 * 3600 * 1000);
					var year = date.getFullYear();
					var month = date.getMonth() + 1;
					var day = date.getDate();
					$("#starttime2").val(formatDate(year + '-' + month + '-' + day));
					$("#endtime2").val(formatDate(myDate.toLocaleDateString().replaceAll("/","-")));
					$("#theform2").submit();
				}
			);
			$("#seven").click();
			$("#seven2").click();
		</script> 
      </div>
    </section>
  </section>
  <!--main content end--> 
</section>
<!-- container section start --> 
<script src="js/jquery-ui-1.10.4.min.js"></script> 
<script type="text/javascript" src="js/jquery-ui-1.9.2.custom.min.js"></script> 
<!-- bootstrap --> 
<script src="js/bootstrap.min.js"></script> 
<!-- nice scroll --> 
<script src="js/jquery.scrollTo.min.js"></script> 
<script src="js/jquery.nicescroll.js" type="text/javascript"></script> 
<!-- charts scripts --> 
<script src="assets/jquery-knob/js/jquery.knob.js"></script> 
<script src="js/jquery.sparkline.js" type="text/javascript"></script> 
<script src="assets/jquery-easy-pie-chart/jquery.easy-pie-chart.js"></script> 
<script src="js/owl.carousel.js"></script> 
<!-- jQuery full calendar --> &lt; 
<script src="js/fullcalendar.min.js"></script> 
<!-- Full Google Calendar - Calendar --> 
<script src="assets/fullcalendar/fullcalendar/fullcalendar.js"></script> 
<!--script for this page only--> 
<script src="js/calendar-custom.js"></script> 
<script src="js/jquery.rateit.min.js"></script> 
<!-- custom select --> 
<script src="js/jquery.customSelect.min.js"></script> 
<script src="assets/chart-master/Chart.js"></script> 
<!--custome script for all page--> 
<script src="js/scripts.js"></script> 
<!-- custom script for this page--> 
<script src="js/sparkline-chart.js"></script> 
<script src="js/easy-pie-chart.js"></script> 
<script src="js/xcharts.min.js"></script> 
<script src="js/jquery.autosize.min.js"></script> 
<script src="js/jquery.placeholder.min.js"></script> 
<script src="js/gdp-data.js"></script> 
<script src="js/morris.min.js"></script> 
<script src="js/sparklines.js"></script> 
<script src="js/charts.js"></script> 
<script src="js/jquery.slimscroll.min.js"></script>
</body>
</html>